function [model,llh] = rvmFast2(X,t)

xbar = mean(X,2);
tbar = mean(t,2);
X = bsxfun(@minus,X,xbar);
t = bsxfun(@minus,t,tbar);

d = size(X,1);

tol = 1e-4;
maxiter = 500;
LLH = -inf(1,maxiter);

X2 = dot(X,X,2);   
Xt = X*t';
[v,j] = max(Xt.^2./X2);

beta = 1/mean(t.^2);   % Beta = 1/sigma^2
phi = X(j,:);
alpha = X2(j)/(v-1/beta);
sigma = 1/(alpha + beta*(phi*phi'));
mu = beta*sigma*phi*t';

V = beta*X*phi';
S = beta*X2-sigma*V.^2;
Q = beta*Xt-beta*sigma*Xt(j)*V;


iUse = j;
Phi = phi;
Alpha = alpha;
Sigma = sigma;
Mu = mu;
for iter = 2:maxiter
    s = S; q = Q;
    s(iUse) = alpha.*S(iUse)./(alpha-S(iUse));
    q(iUse) = alpha.*Q(iUse)./(alpha-S(iUse));
    theta = q.^2-s;
    
    iNew = find(theta>0);

    llh = -inf(d,1); 
    if any(iAdd)
        llh(iAdd) = (Q(iAdd).^2-S(iAdd))./S(iAdd)+log(S(iAdd)./(Q(iAdd).^2));
    end
    [iUpd,~,] = intersect(iNew, iUse); % update    
    if any(iUpd) 
        alpha = s(iUpd).^2./theta(iUpd);
        index = iUse==find(iUpd);
        delta = 1./alpha-1./Alpha(index);
        tllh(iUpd) = Q(iUpd).^2./(S(iUpd)+1./delta)-log1p(S(iUpd).*delta);
    end
    [LLH(iter),j] = max(llh);
    if abs(LLH(iter)-LLH(iter-1)) < tol*abs(LLH(iter)-LLH(2)); break; end
    
    
    
    switch find(iAct(j,:))
        case 1 % Add
            phi = X(j,:);
            alpha = s(j)^2/theta(j);
            sigma = 1/(alpha+S(j));
            mu = sigma*Q(j);

            v = beta*Sigma*(Phi*phi');   
            off = -beta*sigma*v;                     % ?beta
        %     off = -sigma*v;                     % ?beta
            Sigma = [Sigma+sigma*(v*v'), off; off', sigma];
            Mu = [Mu-mu*v; mu];



            e = phi-v'*Phi;
            v = beta*X*e';
            S = S-sigma*v.^2;
            Q = Q-mu*v;

            iUse = [iUse;j];
            Phi = [Phi;phi];
            Alpha = [Alpha;alpha];
        case 2 % update
            
    end
            
end
llh = llh(2:iter);

model.index = iUse;
model.alpha = Alpha;
model.beta = beta;

